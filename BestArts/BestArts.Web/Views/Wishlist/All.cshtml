@model AllProductsQueryModel

@using Microsoft.AspNetCore.Identity;
@using BestArts.Data.Models
@using BestArts.Services.Data.Interfaces
@using BestArts.Web.Infrastructure.Extensions


@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject IWishlistService WishlistService

@{
    ViewData["Title"] = "Wishlist";

    var products = Model.Products.ToList();

    TempData["CurrentPage"] = Model.CurrentPage;
    TempData["CategorySort"] = Model.Category;
    TempData["SearchString"] = Model.SearchString;
    TempData["ProductSorting"] = Model.ProductSorting;
    TempData["ReturnPage"] = "Wishlist";
    TempData["ProductsLeftOnPage"] = @Model.Products.Count();
}

@section css {
    <link rel="stylesheet" href="~/css/styles_products.css" asp-append-version="true" />
}


<div class="content-wrap wishlist">
    <h2 class="page-title divider">@ViewData["Title"]</h2>

    <section class="filter-section">
        <form class="filter-form" method="get">
            <div>
                <div class="form-group">
                    <label asp-for="ProductSorting"></label>
                    <select asp-for="ProductSorting" class="form-control">
                        <option value="0">Newest</option>
                        <option value="1">Oldest</option>
                        <option value="2">Price (Ascending)</option>
                        <option value="3">Price (Descending)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label asp-for="Category"></label>
                    <select asp-for="Category">
                        <option value="">All</option>
                        @foreach (var category in Model.Categories)
                        {
                            <option value="@category">@category</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label asp-for="SearchString"></label>
                    <input asp-for="SearchString" class="form-control" placeholder="Search by text">
                </div>

                <div class="form-group">
                    <input type="submit" value="Search" class="search-btn" />
                </div>
            </div>
        </form>
    </section>

    <section class="pagination-section">
        <div class="pagination">
            @{
                int previousPage = Model.CurrentPage - 1;
                if (previousPage < 1)
                {
                    previousPage = 1;
                }

                int productsPerPage = Model.ProductsPerPage;

                int totalProducts = Model.TotalProducts;

                int maxPage = (int)Math.Ceiling((double)Model.TotalProducts / Model.ProductsPerPage);
            }

            <div class="pagination-arrow">
                <a class="btn-arrow @(Model.CurrentPage == 1 ? "link-disabled" : string.Empty)"
                   asp-controller="Wishlist"
                   asp-action="All"
                   asp-route-currentPage="@previousPage"
                   asp-route-category="@Model.Category"
                   asp-route-searchString="@Model.SearchString"
                   asp-route-productSorting="@((int)Model.ProductSorting)"><i class="fa-solid fa-circle-arrow-left"></i></a>
            </div>

            <div class="pagination-pages">
                @for (int i = 1; i <= maxPage; i++)
                {
                    <a class="page-number @(Model.CurrentPage == i ? "link-disabled current-page" : string.Empty)"
                   asp-controller="Wishlist"
                   asp-action="All"
                   asp-route-currentPage="@i"
                   asp-route-category="@Model.Category"
                   asp-route-searchString="@Model.SearchString"
                   asp-route-productSorting="@((int)Model.ProductSorting)">@i</a>
                }
            </div>

            @{
                bool shouldNextPageBeDisabled = Model.CurrentPage == maxPage ||
                !Model.Products.Any();
            }

            <div class="pagination-arrow">
                <a class="btn-arrow @(shouldNextPageBeDisabled ? "link-disabled" : string.Empty)"
                   asp-controller="Wishlist"
                   asp-action="All"
                   asp-route-currentPage="@(Model.CurrentPage + 1)"
                   asp-route-category="@Model.Category"
                   asp-route-searchString="@Model.SearchString"
                   asp-route-productSorting="@((int)Model.ProductSorting)"><i class="fa-solid fa-circle-arrow-right"></i></a>
            </div>
        </div>
    </section>

    @if (!products.Any())
    {
        <span>
            You have not placed any products in your wishlist yet!
        </span>
    }
    else
    {
        <section class="product-list">
            @foreach (var product in products)
            {
                @*<partial name="_ProductPartial" model="@product" />*@
                <div class="product-box">
                    <div class="product-img">
                        <a asp-controller="Product" asp-action="Details" asp-route-id="@product.Id">
                            <img src="~/img/handmade/@product.ImageUrl" alt="Product Image" />
                        </a>
                    </div>
                    <div class="product-info">
                        <div class="product-name">
                            <a asp-controller="Product" asp-action="Details" asp-route-id="@product.Id">
                                @product.Name
                            </a>
                        </div>
                        <div class="product-type">
                            @product.CategoryName
                        </div>
                        <div class="product-size">
                            @product.Width.ToString("0.#") x @product.Height.ToString("0.#") cm
                        </div>
                        <div class="product-price">
                            @product.Price BGN
                        </div>
                    </div>
                    <div class="product-btns">
                        <form method="post" asp-controller="Product" asp-action="RemoveFromWishlist" asp-route-userId="@User.GetId()" asp-route-productId="@product.Id">
                            <input type="submit" value="Remove" class="wishlist-btn danger-btn button" />
                        </form>

                        <form method="post" asp-controller="Cart" asp-action="AddToCart" asp-route-userId="@User.GetId()" asp-route-productId="@product.Id">
                            <input type="submit" value="Add to basket" class="wishlist-btn green-btn button" />
                        </form>
                    </div>
                </div>
            }
        </section>
    }
</div>